{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>My Orders | CureVia</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --primary: #10847e; --light-bg: #f4f6f8; }
    body { font-family: 'Open Sans', sans-serif; background-color: var(--light-bg); }
    h1, h2, h3, .brand-logo { font-family: 'Rubik', sans-serif; }

    /* Navbar (Simplified for this page) */
    .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .brand-logo { color: var(--primary); font-weight: 700; font-size: 1.5rem; text-decoration: none; }

    /* Order Card */
    .order-card { background: white; border-radius: 10px; border: 1px solid #e0e0e0; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .order-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .order-body { padding: 20px; }

    .status-badge { font-size: 0.8rem; padding: 5px 12px; border-radius: 20px; font-weight: 600; text-transform: uppercase; }
    .status-Pending { background: #fff3cd; color: #856404; }
    .status-Packed { background: #d1ecf1; color: #0c5460; }
    .status-Out { background: #cce5ff; color: #004085; } /* Out for Pickup/Delivery */
    .status-Delivered { background: #d4edda; color: #155724; }
    .status-Rejected { background: #f8d7da; color: #721c24; }

    .item-row { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f1f1f1; padding-bottom: 15px; }
    .item-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; margin-right: 15px; }

    .track-btn { border: 1px solid var(--primary); color: var(--primary); border-radius: 20px; padding: 5px 15px; font-size: 0.85rem; text-decoration: none; transition: 0.2s; }
    .track-btn:hover { background: var(--primary); color: white; }
  </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="brand-logo" href="/user/"><i class="fas fa-chevron-left me-2"></i> CureVia</a>
            <span class="navbar-text fw-bold text-dark">My Orders</span>
        </div>
    </nav>

    <div class="container mt-4 mb-5">

        {% if orders %}
            {% for order in orders %}
            <div class="order-card">
                <!-- Header: Date, ID, Total -->
                <div class="order-header">
                    <div class="d-flex gap-4 text-muted small text-uppercase">
                        <div>
                            <span class="d-block mb-1">Order Placed</span>
                            <span class="text-dark fw-bold">{{ order.date|date:"M d, Y" }}</span>
                        </div>
                        <div>
                            <span class="d-block mb-1">Total</span>
                            <span class="text-dark fw-bold">₹{{ order.grand_total }}</span>
                        </div>
                        <div>
                            <span class="d-block mb-1">Ship To</span>
                            <span class="text-dark fw-bold">Me</span>
                        </div>
                    </div>

                    <div class="text-end">
                        <small class="text-muted d-block mb-1">Order # {{ order.group_id }}</small>
                        <div class="d-flex align-items-center gap-2">
                            <!-- Dynamic Status Badge -->
                            <span class="status-badge
                                {% if 'Pending' in order.status %}status-Pending
                                {% elif 'Packed' in order.status %}status-Packed
                                {% elif 'Out' in order.status %}status-Out
                                {% elif 'Delivered' in order.status %}status-Delivered
                                {% else %}status-Rejected{% endif %}">
                                {{ order.status }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Body: Items -->
                <div class="order-body">
                    <div class="row">
                        <div class="col-md-9">
                            <h6 class="fw-bold mb-3 text-primary">
                                <i class="fas fa-store-alt me-1"></i> {{ order.pharmacy }}
                            </h6>

                            <!-- Items Loop -->
                            {% for item in order.items %}
                            <div class="item-row">
                                {% if item.image %}
                                    <img src="{{ item.image.url }}" class="item-img">
                                {% else %}
                                    <div class="item-img bg-light d-flex align-items-center justify-content-center text-muted"><i class="fas fa-pills"></i></div>
                                {% endif %}

                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-dark">{{ item.name }}</h6>
                                    <small class="text-muted">Qty: {{ item.qty }} × ₹{{ item.price }}</small>
                                </div>
                                <div class="fw-bold">₹{{ item.total }}</div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Action / Tracking Column -->
                        <div class="col-md-3 border-start d-flex flex-col justify-content-center align-items-center">

                            {% if order.status == 'Out for Delivery' and order.delivery_agent %}
                                <div class="text-center mb-3">
                                    <div class="text-success mb-1"><i class="fas fa-motorcycle fa-2x"></i></div>
                                    <small class="fw-bold text-dark">Agent: {{ order.delivery_agent.name }}</small><br>
                                    <a href="tel:{{ order.delivery_agent.phone }}" class="text-decoration-none small text-muted">
                                        <i class="fas fa-phone"></i> Call Agent
                                    </a>
                                </div>
                            {% endif %}

                            {% if order.status == 'Delivered' %}
                                <button class="btn btn-sm btn-outline-success w-100 disabled mb-2">
                                    <i class="fas fa-check-circle"></i> Delivered
                                </button>
                                <a href="#" class="btn btn-sm btn-light w-100 border">Invoice</a>
                            {% else %}
                                <a href="{% url 'track_order' order.group_id %}" class="btn btn-sm btn-light w-100 border text-primary fw-bold">
                                Track Package
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <div class="mb-3 text-muted opacity-50">
                    <i class="fas fa-box-open fa-4x"></i>
                </div>
                <h3>No orders yet</h3>
                <p class="text-muted">Looks like you haven't placed an order yet.</p>
                <a href="/shop/" class="btn btn-primary mt-2">Start Shopping</a>
            </div>
        {% endif %}

    </div>

</body>
</html>