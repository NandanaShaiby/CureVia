<!DOCTYPE html>
<html lang="en">
<head>
    <title>Delivery Partner | CureVia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }

        /* Header */
        .app-header { background-color: #343a40; color: white; padding: 15px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .agent-status { font-size: 0.8rem; background: #28a745; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }

        /* Cards */
        .task-card { border: none; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header-custom { padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }

        /* Pickup Color */
        .card-pickup .card-header-custom { background: #fff3cd; color: #856404; }
        .btn-pickup { background: #ffc107; color: #000; font-weight: bold; width: 100%; border: none; }

        /* Delivery Color */
        .card-delivery .card-header-custom { background: #d1ecf1; color: #0c5460; }
        .btn-deliver { background: #17a2b8; color: white; font-weight: bold; width: 100%; border: none; }

        .info-row { display: flex; align-items: flex-start; margin-bottom: 10px; }
        .info-icon { width: 30px; text-align: center; color: #6c757d; margin-right: 10px; }

        /* Tabs */
        .nav-pills .nav-link { border-radius: 20px; color: #6c757d; font-weight: 600; }
        .nav-pills .nav-link.active { background-color: #343a40; color: white; }
    </style>
</head>
<body>

    <!-- 1. APP HEADER -->
    <div class="app-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1">Hi, {{ agent.name }}</h5>

                <!-- Location Display -->
                <small class="d-block text-white-50 mb-2">
                    <i class="fas fa-map-marker-alt"></i> {{ agent.current_location }}
                </small>

                <!-- STATUS TOGGLE FORM -->
                <div class="d-flex align-items-center">
                    <form action="{% url 'toggle_agent_status' %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm rounded-pill fw-bold border-0
                            {% if agent.is_available %}btn-success{% else %}btn-secondary{% endif %}"
                            style="min-width: 100px; font-size: 0.8rem;">

                            {% if agent.is_available %}
                                <i class="fas fa-toggle-on"></i> Online
                            {% else %}
                                <i class="fas fa-toggle-off"></i> Offline
                            {% endif %}
                        </button>
                    </form>
                </div>
            </div>

            <!-- Logout Icon -->
            <a href="#" class="text-white opacity-75">
                <i class="fas fa-sign-out-alt fa-lg"></i>
            </a>
        </div>
    </div>

    <div class="container">

        <!-- 2. TABS (Tasks vs History) -->
        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button">Current Tasks</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button">History</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">

            <!-- CURRENT TASKS TAB -->
            <div class="tab-pane fade show active" id="pills-home">

                <!-- A. NEW PICKUP REQUESTS -->
                {% if new_tasks %}
                    <h6 class="text-muted fw-bold mb-3 small">ðŸš€ PICKUP FROM PHARMACY</h6>
                    {% for order in new_tasks %}
                    <div class="card task-card card-pickup">
                        <div class="card-header-custom">
                            <span>Order #{{ order.order_group_id }}</span>
                            <span class="badge bg-warning text-dark">Pickup</span>
                        </div>
                        <div class="card-body">
                            <!-- Pharmacy Info -->
                            <div class="info-row">
                                <div class="info-icon"><i class="fas fa-store"></i></div>
                                <div>
                                    <strong class="d-block">{{ order.assigned_pharmacy.name }}</strong>
                                    <small class="text-muted">{{ order.assigned_pharmacy.address }}</small>
                                </div>
                            </div>

                            <!-- Customer Info -->
                            <div class="info-row">
                                <div class="info-icon"><i class="fas fa-user"></i></div>
                                <div>
                                    <span class="d-block">Deliver to: {{ order.fname }}</span>
                                </div>
                            </div>

                            <hr>

                            <!-- Actions: Accept OR Reject -->
                            <form action="{% url 'delivery_update_status' order.id %}" method="POST" class="d-flex gap-2">
                                {% csrf_token %}

                                <!-- Accept Button (Green) -->
                                <button type="submit" name="action" value="pickup" class="btn btn-pickup py-2 rounded-pill flex-grow-1">
                                    <i class="fas fa-box-open me-2"></i> Confirm Pickup
                                </button>

                                <!-- Reject Button (Red Outline) -->
                                <button type="submit" name="action" value="reject" class="btn btn-outline-danger py-2 rounded-pill" onclick="return confirm('Reject this task? It will be re-assigned.');">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                <!-- B. ACTIVE DELIVERIES -->
                {% if active_deliveries %}
                    <h6 class="text-muted fw-bold mb-3 mt-4 small">ðŸšš DELIVER TO CUSTOMER</h6>
                    {% for order in active_deliveries %}
                    <div class="card task-card card-delivery">
                        <div class="card-header-custom">
                            <span>Order #{{ order.order_group_id }}</span>
                            <span class="badge bg-info text-white">On The Way</span>
                        </div>
                        <div class="card-body">
                            <!-- Customer Address -->
                            <div class="info-row">
                                <div class="info-icon"><i class="fas fa-map-marker-alt text-danger"></i></div>
                                <div>
                                    <strong class="d-block">{{ order.fname }}</strong>
                                    <small class="text-muted">{{ order.address }}</small>
                                    <div class="mt-1"><a href="tel:{{ order.phone }}" class="text-decoration-none fw-bold"><i class="fas fa-phone me-1"></i> {{ order.phone }}</a></div>
                                </div>
                            </div>

                            <!-- Payment Info -->
                            <div class="bg-light p-2 rounded mb-3 text-center border">
                                {% if order.payment_mode == 'COD' %}
                                    <!-- Using simple calculation or just text to avoid template error -->
                                    <span class="text-danger fw-bold"><i class="fas fa-money-bill-wave me-1"></i> Collect Cash: â‚¹{{ order.medicine.price }} (x{{ order.quantity }})</span>
                                {% else %}
                                    <span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i> Prepaid Order</span>
                                {% endif %}
                            </div>

                            <!-- Action: Mark Delivered (Only one button here!) -->
                            <form action="{% url 'delivery_update_status' order.id %}" method="POST">
                                {% csrf_token %}
                                <button type="submit" name="action" value="deliver" class="btn btn-success w-100 py-2 rounded-pill fw-bold" onclick="return confirm('Confirm delivery complete?');">
                                    <i class="fas fa-check-double me-2"></i> Mark Delivered
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                {% if not new_tasks and not active_deliveries %}
                    <div class="text-center mt-5 text-muted">
                        <i class="fas fa-clipboard-check fa-4x mb-3 text-secondary opacity-25"></i>
                        <p>No active tasks right now.</p>
                        <p class="small">Make sure you are <strong class="text-success">Online</strong> to receive tasks.</p>
                    </div>
                {% endif %}
            </div>

            <!-- HISTORY TAB -->
            <div class="tab-pane fade" id="pills-profile">
                <div class="list-group">
                    {% for order in history %}
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Order #{{ order.order_group_id }}</h6>
                            <small class="text-muted">{{ order.created_at|date:"M d" }}</small>
                        </div>
                        <p class="mb-1 small text-success"><i class="fas fa-check-circle me-1"></i> Delivered</p>
                        <small class="text-muted">To: {{ order.fname }}</small>
                    </div>
                    {% empty %}
                    <div class="text-center p-4 text-muted">No delivery history yet.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>