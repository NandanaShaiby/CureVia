{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pharmacist Dashboard | CureVia</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Fonts: Rubik & Open Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- CureVia Professional Theme --- */
    :root {
      --primary: #10847e;
      --primary-dark: #0a6b66;
      --light: #f2f7fb;
      --dark: #30363c;
      --gray: #8897a2;
      --border-color: #e0e0e0;
      --card-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }

    body { font-family: 'Open Sans', sans-serif; background-color: #f4f6f8; color: var(--dark); }
    h1, h2, h3, h4, h5, h6, .brand-logo, .nav-link, .btn { font-family: 'Rubik', sans-serif; }

    /* --- Navbar --- */
    .navbar { background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 12px 0; }
    .brand-logo { text-transform: uppercase; letter-spacing: .1em; font-size: 22px; font-weight: 700; color: var(--primary) !important; text-decoration: none; }
    .nav-link { font-weight: 500; color: var(--gray); margin: 0 10px; }
    .nav-link.active, .nav-link:hover { color: var(--primary); }
    .user-badge { background-color: var(--light); padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; color: var(--primary-dark); font-weight: 600; }

    /* --- Dashboard Header --- */
    .dashboard-header { background-color: var(--primary); color: white; padding: 40px 0; margin-bottom: 30px; background-image: linear-gradient(135deg, #10847e 0%, #0a6b66 100%); }
    .dashboard-title { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
    .dashboard-subtitle { opacity: 0.9; font-size: 1rem; font-weight: 400; }

    /* --- Stats Cards --- */
    .stat-card { background: white; border-radius: 10px; padding: 25px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); transition: 0.3s; height: 100%; display: flex; align-items: center; justify-content: space-between; text-decoration: none; color: inherit; }
    .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 8px 20px rgba(16, 132, 126, 0.1); }
    .stat-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
    .icon-blue { background-color: #e3f2fd; color: #1976d2; }
    .icon-orange { background-color: #fff3e0; color: #f57c00; }
    .icon-green { background-color: #e8f5e9; color: #388e3c; }
    .icon-red { background-color: #ffebee; color: #d32f2f; }
    .stat-number { font-size: 2rem; font-weight: 700; color: var(--dark); line-height: 1; margin-bottom: 5px; }
    .stat-label { color: var(--gray); font-size: 0.9rem; font-weight: 500; }

    /* --- Tables --- */
    .content-panel { background: white; border-radius: 12px; box-shadow: var(--card-shadow); padding: 30px; margin-bottom: 30px; border: 1px solid var(--border-color); }
    .section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
    .section-title i { margin-right: 10px; color: var(--primary); }
    .table { margin-bottom: 0; }
    .table thead th { background-color: #f8f9fa; color: var(--gray); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; border-bottom: 2px solid #eee; padding: 15px; }
    .table tbody td { vertical-align: middle; padding: 15px; border-bottom: 1px solid #f0f0f0; color: #444; font-size: 0.95rem; }

    /* Badges & Buttons */
    .badge-soft { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .bg-soft-warning { background-color: #fff3cd; color: #856404; }
    .bg-soft-info { background-color: #d1ecf1; color: #0c5460; }
    .bg-soft-success { background-color: #d4edda; color: #155724; }
    .bg-soft-danger { background-color: #f8d7da; color: #721c24; }
    .btn-action { padding: 5px 12px; font-size: 0.85rem; font-weight: 500; border-radius: 6px; transition: 0.2s; }

    footer { margin-top: 50px; padding: 20px 0; border-top: 1px solid #ddd; color: var(--gray); font-size: 0.9rem; }
  </style>
</head>
<body>

  <!-- REGROUP DATA LOGIC -->
  {% regroup pending_orders by order_group_id as order_list %}

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand brand-logo" href="/pharmacist/">CureVia <span class="fs-6 text-muted ms-2 fw-normal">| Partner</span></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navContent">
        <ul class="navbar-nav me-auto ms-4">
          <li class="nav-item"><a class="nav-link active" href="/pharmacist/">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/addmed/">Add Medicine</a></li>
          <li class="nav-item"><a class="nav-link" href="/view_prescriptions/">Prescriptions</a></li>
          <li class="nav-item"><a class="nav-link" href="/inventory/">Inventory</a></li>
        </ul>
        <div class="d-flex align-items-center gap-3">
            <div class="user-badge d-none d-md-block">
                <i class="fas fa-store me-2"></i> {{ pharmacy.name }}
            </div>
            <a href="/logout/" class="btn btn-outline-danger btn-sm px-3">Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Dashboard Header -->
  <div class="dashboard-header">
      <div class="container">
          <div class="row">
              <div class="col-12">
                  <!-- CHANGED: Use 'staff_name' from session, not pharmacist.fname -->
                  <h1 class="dashboard-title">Welcome, {{ staff_name }}</h1>
                  <p class="dashboard-subtitle">Managing Store: {{ pharmacy.location }}</p>
              </div>
          </div>
      </div>
  </div>

  <!-- Main Content -->
  <div class="container">

      <!-- STATS GRID -->
      <div class="row g-4 mb-5">
          <div class="col-md-6 col-lg-3">
              <a href="#orders-section" class="stat-card">
                  <div>
                      <div class="stat-number">{{ order_list|length }}</div>
                      <div class="stat-label">Pending Orders</div>
                  </div>
                  <div class="stat-icon icon-blue"><i class="fas fa-shopping-cart"></i></div>
              </a>
          </div>
          <div class="col-md-6 col-lg-3">
              <a href="#prescriptions-section" class="stat-card">
                  <div>
                      <div class="stat-number">{{ pending_prescriptions.count }}</div>
                      <div class="stat-label">Rx Reviews</div>
                  </div>
                  <div class="stat-icon icon-orange"><i class="fas fa-file-medical"></i></div>
              </a>
          </div>
          <div class="col-md-6 col-lg-3">
              <a href="/inventory/" class="stat-card">
                  <div>
                      <div class="stat-number">{{ low_stock_meds.count }}</div>
                      <div class="stat-label">Low Stock Items</div>
                  </div>
                  <div class="stat-icon icon-red"><i class="fas fa-exclamation-triangle"></i></div>
              </a>
          </div>
          <div class="col-md-6 col-lg-3">
              <div class="stat-card">
                  <div>
                      <div class="stat-number">â‚¹--</div>
                      <div class="stat-label">Today's Revenue</div>
                  </div>
                  <div class="stat-icon icon-green"><i class="fas fa-wallet"></i></div>
              </div>
          </div>
      </div>

      <!-- SECTION 1: PRESCRIPTION REVIEW (The Image Uploads) -->
      <div id="prescriptions-section" class="content-panel">
          <h3 class="section-title">
              <span><i class="fas fa-file-prescription"></i> Prescription Reviews</span>
              {% if pending_prescriptions %}
              <span class="badge bg-danger ms-auto rounded-pill">{{ pending_prescriptions.count }} New</span>
              {% endif %}
          </h3>

          {% if pending_prescriptions %}
          <div class="table-responsive">
              <table class="table">
                  <thead>
                      <tr>
                          <th>ID</th>
                          <th>Customer</th>
                          <th>Type</th>
                          <th>Status</th>
                          <th class="text-end">Action</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for pres in pending_prescriptions %}
                      <tr>
                          <td class="fw-bold">#{{ pres.id }}</td>
                          <td>{{ pres.user.fname }}</td>
                          <td>
                              {% if pres.delivery_type == 'Home' %}
                                  <span class="badge badge-soft bg-soft-info">Home Delivery</span>
                              {% else %}
                                  <span class="badge badge-soft bg-soft-warning">Pickup</span>
                              {% endif %}
                          </td>
                          <td>
                              <!-- CHANGED: locked_by -> locked_by_pharmacy -->
                              {% if pres.locked_by_pharmacy %}
                                  {% if pres.locked_by_pharmacy.id == pharmacy.id %}
                                      <span class="badge badge-soft bg-soft-success"><i class="fas fa-lock me-1"></i> Reviewing</span>
                                  {% else %}
                                      <span class="badge badge-soft bg-soft-danger"><i class="fas fa-lock me-1"></i> Locked by Other</span>
                                  {% endif %}
                              {% else %}
                                  <span class="badge badge-soft bg-secondary">Open</span>
                              {% endif %}
                          </td>
                          <td class="text-end">
                              <!-- CHANGED: Locking logic variables -->
                              {% if pres.locked_by_pharmacy and pres.locked_by_pharmacy.id != pharmacy.id %}
                                  <button class="btn btn-secondary btn-sm" disabled>Locked</button>
                              {% elif pres.locked_by_pharmacy and pres.locked_by_pharmacy.id == pharmacy.id %}
                                  <a href="{% url 'lock_and_process' pres.id %}" class="btn btn-success btn-sm btn-action">Continue</a>
                              {% else %}
                                  <a href="{% url 'lock_and_process' pres.id %}" class="btn btn-primary btn-sm btn-action">Process</a>
                              {% endif %}
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
          </div>
          {% else %}
              <div class="text-center py-4 text-muted">
                  <i class="fas fa-check-circle fa-3x mb-3 text-success opacity-50"></i>
                  <p>All cleared! No pending prescriptions.</p>
              </div>
          {% endif %}
      </div>

      <!-- SECTION 2: CART ORDERS (Ready to Pack) -->
      <div id="orders-section" class="content-panel">
          <h3 class="section-title">
              <span><i class="fas fa-box-open"></i> Cart Orders</span>
              {% if order_list %}
              <span class="badge bg-primary ms-auto rounded-pill">{{ order_list|length }} Pending</span>
              {% endif %}
          </h3>

          {% if order_list %}
          <div class="table-responsive">
              <table class="table">
                  <thead>
                      <tr>
                          <th style="width: 15%;">Group ID</th>
                          <th style="width: 20%;">Customer Info</th>
                          <th style="width: 35%;">Order Items</th>
                          <th style="width: 15%;">Status</th>
                          <th style="width: 15%;" class="text-center">Quick Action</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for group in order_list %}
                      <tr>
                          <td>
                              {% if group.grouper %}
                                  <span class="fw-bold text-primary">{{ group.grouper }}</span>
                              {% else %}
                                  <span class="text-muted fst-italic">Single Item</span>
                              {% endif %}
                          </td>
                          <td>
                              <div class="fw-bold">{{ group.list.0.fname }}</div>
                              <div class="small text-muted">{{ group.list.0.phone }}</div>
                              <div class="badge bg-light text-dark border mt-1">{{ group.list.0.payment_mode }}</div>
                          </td>
                          <td>
                              <ul class="list-unstyled mb-0 small">
                                  {% for item in group.list %}
                                  <li class="mb-2 d-flex justify-content-between align-items-center border-bottom pb-1">
                                      <span>
                                          {{ item.medicine.name }}
                                          <span class="text-muted fw-bold">x {{ item.quantity }}</span>
                                      </span>
                                      {% if item.medicine.quantity >= item.quantity %}
                                          <span class="text-success"><i class="fas fa-check-circle"></i> In Stock</span>
                                      {% else %}
                                          <span class="text-danger fw-bold">Out of Stock</span>
                                      {% endif %}
                                  </li>
                                  {% endfor %}
                              </ul>
                          </td>
                          <td>
                              <span class="badge badge-soft bg-soft-warning">{{ group.list.0.status }}</span>
                          </td>
                          <td class="text-center">
                              {% if group.list.0.status == 'Pending' or group.list.0.status == 'Confirmed' %}
                                  <form action="{% url 'process_group_order' group.grouper %}" method="POST">
                                      {% csrf_token %}
                                      <button type="submit" name="action" value="approve_all" class="btn btn-outline-success btn-sm w-100 mb-2 btn-action" onclick="return confirm('Confirm Pack All?');">
                                          <i class="fas fa-check"></i> Pack All
                                      </button>
                                      <button type="submit" name="action" value="reject_all" class="btn btn-outline-danger btn-sm w-100 btn-action" onclick="return confirm('Reject Entire Order?');">
                                          <i class="fas fa-times"></i> Reject
                                      </button>
                                  </form>
                              {% elif group.list.0.status == 'Packed' %}
                                  <div class="text-success small fw-bold">
                                      <i class="fas fa-check-double"></i> Ready for Agent
                                  </div>
                              {% endif %}
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
          </div>
          {% else %}
              <div class="text-center py-4 text-muted">
                  <i class="fas fa-shopping-basket fa-3x mb-3 text-secondary opacity-50"></i>
                  <p>No new orders to pack.</p>
              </div>
          {% endif %}
      </div>

  </div>

  <footer class="text-center">
      <div class="container">
          <p class="mb-0">&copy; <script>document.write(new Date().getFullYear());</script> CureVia Partner Portal. All rights reserved.</p>
      </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>